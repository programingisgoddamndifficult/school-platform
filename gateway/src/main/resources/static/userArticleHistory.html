<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户观看历史文章历史记录</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    header {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .article-list {
      list-style-type: none;
      padding: 0;
      margin: 20px;
    }

    .article-item {
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .article-item h3 {
      margin-top: 0;
    }

    .article-item p {
      color: #666;
    }

    .article-item button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 10px;
    }

    .article-item button:hover {
      background-color: #0056b3;
    }

    .delete-button {
      background-color: #dc3545;
    }

    .delete-button:hover {
      background-color: #c82333;
    }

    #delete-all-button {
      display: block;
      margin: 20px auto;
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
    }

    #delete-all-button:hover {
      background-color: #c82333;
    }
  </style>
</head>

<body>
<header>
  <h1>用户观看历史记录</h1>
</header>
<button id="delete-all-button">删除所有记录</button>
<ul class="article-list">
  <!-- 这里会通过 JavaScript 动态添加文章项 -->
</ul>
<script>
  // 定义文章类型映射
  const tagMap = {
    1: '交友',
    2: '恋爱',
    3: '二手',
    4: '代课',
    5: '提问',
    6: '分享'
  };

  // 定义接口 URL 和请求头
  const apiUrl = 'http://127.0.0.1/api/user/article/selfList';
  const deleteUrl = 'http://127.0.0.1/api/user/article/selfList/delete';
  var token = localStorage.getItem('authorization');
  const authorizationToken = token;
  const headers = {
    'Authorization': authorizationToken,
    'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
    'Content-Type': 'application/json'
  };

  // 存储所有文章记录的 id
  let allRecordIds = [];

  // 发起请求
  fetch(apiUrl, {
    method: 'GET',
    headers: headers
  })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.code === '200') {
              const articleList = document.querySelector('.article-list');
              data.data.forEach(article => {
                allRecordIds.push(article.id);
                const articleItem = document.createElement('li');
                articleItem.classList.add('article-item');

                const title = document.createElement('h3');
                title.textContent = article.articleTitle;

                const watchTime = document.createElement('p');
                watchTime.textContent = `观看时间：${article.watchTime}`;

                const tag = document.createElement('p');
                const tagText = tagMap[article.tag] || '未知类型';
                tag.textContent = `文章类型：${tagText}`;

                const viewButton = document.createElement('button');
                viewButton.textContent = '查看文章';

                // 为查看文章按钮添加点击事件监听器
                viewButton.addEventListener('click', function () {
                  const articleId = article.articleId;
                  const authorization = localStorage.getItem('authorization');
                  const url = `article_detail.html?articleId=${articleId}&authorization=${authorization}`;
                  window.location.href = url;
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = '删除记录';
                deleteButton.classList.add('delete-button');

                // 为删除记录按钮添加点击事件监听器
                deleteButton.addEventListener('click', function () {
                  const recordId = article.id;
                  const deleteData = {
                    ids: [recordId]
                  };
                  fetch(deleteUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(deleteData)
                  })
                          .then(response => {
                            if (!response.ok) {
                              throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                          })
                          .then(deleteResponse => {
                            if (deleteResponse.code === '200') {
                              // 删除成功，从页面中移除该文章项
                              articleItem.remove();
                              // 从 allRecordIds 中移除该 id
                              allRecordIds = allRecordIds.filter(id => id!== recordId);
                              console.log('删除记录成功');
                            } else {
                              console.error('删除记录失败:', deleteResponse.msg);
                            }
                          })
                          .catch(error => {
                            console.error('删除记录请求出错:', error);
                          });
                });

                articleItem.appendChild(title);
                articleItem.appendChild(watchTime);
                articleItem.appendChild(tag);
                articleItem.appendChild(viewButton);
                articleItem.appendChild(deleteButton);

                articleList.appendChild(articleItem);
              });
            } else {
              console.error('请求失败:', data.msg);
            }
          })
          .catch(error => {
            console.error('请求出错:', error);
          });

  // 为删除所有记录按钮添加点击事件监听器
  const deleteAllButton = document.getElementById('delete-all-button');
  deleteAllButton.addEventListener('click', function () {
    if (allRecordIds.length === 0) {
      console.log('没有记录可删除');
      return;
    }
    const deleteData = {
      ids: allRecordIds
    };
    fetch(deleteUrl, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(deleteData)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(deleteResponse => {
              if (deleteResponse.code === '200') {
                // 删除成功，清空文章列表
                const articleList = document.querySelector('.article-list');
                articleList.innerHTML = '';
                allRecordIds = [];
                console.log('删除所有记录成功');
              } else {
                console.error('删除所有记录失败:', deleteResponse.msg);
              }
            })
            .catch(error => {
              console.error('删除所有记录请求出错:', error);
            });
  });
</script>
</body>

</html>