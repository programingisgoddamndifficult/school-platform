<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–‡ç« è¯¦æƒ…</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" />
  <style>
    /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding-bottom: 40px;
    }
    header {
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
      padding: 20px;
      text-align: center;
      color: #fff;
      font-size: 24px;
      font-weight: 500;
    }
    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 800px;
      margin: 20px auto;
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    /* æ–‡ç« æ ‡é¢˜ */
    .article-title {
      font-size: 2em;
      margin-bottom: 10px;
      word-break: break-all;
      cursor: pointer;
    }
    .article-title:hover {
      opacity: 0.9;
    }
    /* ä½œè€…ä¿¡æ¯ */
    .author-info {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 10px;
    }
    /* æ–‡ç« å†…å®¹ */
    .article-content {
      font-size: 1.1em;
      line-height: 1.8;
      margin-bottom: 20px;
      text-align: left;
      word-break: break-word;
    }
    /* æ–‡ç« ç»Ÿè®¡åŒº */
    .article-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #eee;
      padding-top: 15px;
      margin-bottom: 10px;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .like-button,
    .collect-button {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      outline: none;
    }
    .like-button.liked {
      color: red;
    }
    .collect-button.collected {
      color: gold;
    }
    .create-time {
      text-align: right;
      font-size: 0.9em;
      color: #888;
      margin-bottom: 20px;
    }
    /* è¯„è®ºåŒºåŸŸ */
    .comment-container {
      margin-top: 20px;
    }
    #comment-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #comment-box {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    #comment-button {
      padding: 10px 20px;
      border: none;
      background-color: #74c0fc;
      color: #fff;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #comment-button:hover {
      background-color: #4dabf7;
    }
    #comment-section {
      margin-top: 10px;
    }
    .comment-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 15px;
    }
    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ccc;
      flex-shrink: 0;
    }
    .comment-info {
      background-color: #f0f0f0;
      border-radius: 8px;
      padding: 10px;
      flex: 1;
    }
    .comment-author {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .comment-time {
      font-size: 0.8em;
      color: #888;
      margin-top: 5px;
    }
    /* AIæ™ºèƒ½æ€»ç»“ */
    .ai-summary-container {
      position: absolute;
      top: 20px;
      right: 20px;
      text-align: right;
    }
    #ai-summary-button {
      background-color: #74c0fc;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #ai-summary-button:hover {
      background-color: #4dabf7;
    }
    /* å¼¹çª—æ ·å¼ */
    #summary-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 80%;
      max-width: 600px;
    }
    #summary-modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 20px;
    }
    #summary-modal h2 {
      margin-top: 0;
      text-align: center;
    }
    #summary-modal-content {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>

<body>
<header>æ ¡å›­è®ºå› - æ–‡ç« è¯¦æƒ…</header>
<div class="container">
  <h1 class="article-title" id="article-title"></h1>
  <div class="author-info" id="author-info">
    <div class="author-avatar" id="author-avatar"></div>
    <span id="author-name"></span>
  </div>
  <div class="article-content" id="article-content"></div>
  <div class="article-stats">
    <div class="stat-item">
      <button class="like-button" id="like-button">
        <span class="stat-icon">â¤ï¸</span>
        <span id="likes-num"></span>
      </button>
    </div>
    <div class="stat-item">
      <span class="stat-icon">ğŸ‘ï¸</span>
      <span id="read-num"></span>
    </div>
    <div class="stat-item">
      <button class="collect-button" id="collect-button">
        <span class="stat-icon">â­</span>
        <span id="collect-num"></span>
      </button>
    </div>
  </div>
  <div class="create-time" id="create-time"></div>

  <div id="comment-container">
    <input type="text" id="comment-box" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹">
    <button id="comment-button">è¯„è®º</button>
  </div>
  <div id="comment-section"></div>

  <!-- AIæ™ºèƒ½æ€»ç»“ -->
  <div class="ai-summary-container">
    <p style="font-size: 0.9em; color: #555;">æ–‡å­—å¤ªå¤šï¼Ÿè®©AIå¸®ä½ æ€»ç»“</p>
    <button id="ai-summary-button">æ™ºèƒ½æ€»ç»“</button>
  </div>
</div>

<!-- å¼¹çª— -->
<div id="summary-modal">
  <div id="summary-modal-close">Ã—</div>
  <h2>æ™ºèƒ½æ€»ç»“</h2>
  <div id="summary-modal-content"></div>
</div>

<script>
  // ä»URLä¸­è·å–å‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  const articleId = urlParams.get('articleId');
  const authorization = localStorage.getItem('authorization')

  if (!articleId || !authorization) {
    alert('ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œè¯·é‡æ–°è®¿é—®ã€‚');
    window.location.href = 'index.html';
  } else {
    // å‘èµ·è¯·æ±‚è·å–æ–‡ç« è¯¦æƒ…
    function fetchArticleDetail() {
      fetch(`http://127.0.0.1/api/user/article/detail?articleId=${articleId}`, {
        method: 'GET',
        headers: {
          'Authorization': `${authorization}`,
          'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
        }
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                if (data.code === '200') {
                  const articleData = data.data;
                  document.getElementById('article-title').textContent = articleData.title;
                  document.getElementById('author-name').textContent = articleData.userInfo.username;
                  document.getElementById('article-content').textContent = articleData.content;
                  document.getElementById('likes-num').textContent = articleData.likesNum;
                  document.getElementById('read-num').textContent = articleData.readNum;
                  document.getElementById('collect-num').textContent = articleData.collectNum;
                  document.getElementById('create-time').textContent = articleData.createTime;
                  // åˆå§‹åŠ è½½æ—¶æŸ¥è¯¢ç‚¹èµå’Œæ”¶è—çŠ¶æ€
                  checkLikeStatus();
                  checkCollectStatus();
                  // åŠ è½½è¯„è®ºåˆ—è¡¨
                  fetchCommentList();
                }
              })
              .catch(error => {
                const errorMessage = `å‘ç”Ÿé”™è¯¯: ${error.message}`;
                alert(errorMessage);
              });
    }
    fetchArticleDetail();
  }

  // æŸ¥è¯¢ç‚¹èµçŠ¶æ€
  function checkLikeStatus() {
    fetch(`http://127.0.0.1/api/user/article/like?articleId=${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const likeButton = document.getElementById('like-button');
                if (data.data.like) {
                  likeButton.classList.add('liked');
                } else {
                  likeButton.classList.remove('liked');
                }
              }
            })
            .catch(error => {
              console.error('æŸ¥è¯¢ç‚¹èµçŠ¶æ€é”™è¯¯:', error);
            });
  }

  // æŸ¥è¯¢æ”¶è—çŠ¶æ€
  function checkCollectStatus() {
    fetch(`http://127.0.0.1/api/user/article/collect?articleId=${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const collectButton = document.getElementById('collect-button');
                if (data.data.collect) {
                  collectButton.classList.add('collected');
                } else {
                  collectButton.classList.remove('collected');
                }
              }
            })
            .catch(error => {
              console.error('æŸ¥è¯¢æ”¶è—çŠ¶æ€é”™è¯¯:', error);
            });
  }

  // ç‚¹èµ/å–æ¶ˆç‚¹èµ
  document.getElementById('like-button').addEventListener('click', function () {
    const likeButton = this;
    fetch(`http://127.0.0.1/api/user/article/like/${articleId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                // é‡æ–°æŸ¥è¯¢ç‚¹èµçŠ¶æ€
                checkLikeStatus();
                // é‡æ–°è·å–æ–‡ç« è¯¦æƒ…
                fetchArticleDetail();
              }
            })
            .catch(error => {
              console.error('ç‚¹èµ/å–æ¶ˆç‚¹èµé”™è¯¯:', error);
            });
  });

  // æ”¶è—/å–æ¶ˆæ”¶è—
  document.getElementById('collect-button').addEventListener('click', function () {
    const collectButton = this;
    fetch(`http://127.0.0.1/api/user/article/collect/${articleId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                // é‡æ–°æŸ¥è¯¢æ”¶è—çŠ¶æ€
                checkCollectStatus();
                // é‡æ–°è·å–æ–‡ç« è¯¦æƒ…
                fetchArticleDetail();
              }
            })
            .catch(error => {
              console.error('æ”¶è—/å–æ¶ˆæ”¶è—é”™è¯¯:', error);
            });
  });

  // å¤„ç†è¯„è®ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  document.getElementById('comment-button').addEventListener('click', function () {
    const commentBox = document.getElementById('comment-box');
    const comment = commentBox.value.trim();
    if (comment.length > 100) {
      alert('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦');
      return;
    }
    if (comment !== '') {
      fetch('http://127.0.0.1/api/user/article/comment', {
        method: 'POST',
        headers: {
          'Authorization': `${authorization}`,
          'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          articleId: parseInt(articleId),
          comment: comment,
          level: 1
        })
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === '200') {
                  alert('è¯„è®ºæˆåŠŸ');
                  commentBox.value = ''; // æ¸…ç©ºè¯„è®ºæ¡†
                  // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                  fetchCommentList();
                } else {
                  alert('è¯„è®ºå¤±è´¥: ' + data.msg);
                }
              })
              .catch(error => {
                console.error('è¯„è®ºè¯·æ±‚é”™è¯¯:', error);
                alert('è¯„è®ºè¯·æ±‚å‘ç”Ÿé”™è¯¯');
              });
    } else {
      alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
    }
  });

  // è·å–è¯„è®ºåˆ—è¡¨
  function fetchCommentList() {
    fetch(`http://127.0.0.1/api/user/article/comment/${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const commentSection = document.getElementById('comment-section');
                commentSection.innerHTML = ''; // æ¸…ç©ºè¯„è®ºåŒº
                const comments = data.data;
                comments.forEach(comment => {
                  const commentItem = document.createElement('div');
                  commentItem.classList.add('comment-item');

                  const commentAvatar = document.createElement('div');
                  commentAvatar.classList.add('comment-avatar');

                  const commentInfo = document.createElement('div');
                  commentInfo.classList.add('comment-info');

                  const commentAuthor = document.createElement('span');
                  commentAuthor.classList.add('comment-author');
                  commentAuthor.textContent = `${comment.userCommentInfo.username}: `;

                  const commentContent = document.createElement('span');
                  commentContent.textContent = comment.articleCommentInfo.comment;

                  const commentTime = document.createElement('span');
                  commentTime.classList.add('comment-time');
                  commentTime.textContent = comment.articleCommentInfo.createTime;

                  commentInfo.appendChild(commentAuthor);
                  commentInfo.appendChild(commentContent);
                  commentInfo.appendChild(commentTime);

                  commentItem.appendChild(commentAvatar);
                  commentItem.appendChild(commentInfo);

                  commentSection.appendChild(commentItem);
                });
              }
            })
            .catch(error => {
              console.error('è·å–è¯„è®ºåˆ—è¡¨é”™è¯¯:', error);
            });
  }

  // å¤„ç†æ™ºèƒ½æ€»ç»“æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  document.getElementById('ai-summary-button').addEventListener('click', function () {
    fetch(`http://127.0.0.1/api/user/ai/sum/${articleId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const summaryContent = data.data.content;
                const summaryModal = document.getElementById('summary-modal');
                const summaryModalContent = document.getElementById('summary-modal-content');
                summaryModalContent.textContent = summaryContent;
                summaryModal.style.display = 'block';
              }
            })
            .catch(error => {
              console.error('è·å–AIæ€»ç»“é”™è¯¯:', error);
            });
  });

  // å…³é—­å¼¹çª—
  document.getElementById('summary-modal-close').addEventListener('click', function () {
    const summaryModal = document.getElementById('summary-modal');
    summaryModal.style.display = 'none';
  });
</script>
</body>

</html>
