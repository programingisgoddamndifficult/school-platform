<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article Detail</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 2em;
      max-width: 70%;
      margin: 0 auto 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }

    h1:hover {
      white-space: normal;
      overflow: visible;
    }

    #author-info {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }

    #author-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 10px;
    }

    #article-content {
      text-align: center;
      margin-bottom: 20px;
      max-width: 70%;
      margin-left: auto;
      margin-right: auto;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 10;
      -webkit-box-orient: vertical;
    }

    #article-stats {
      position: absolute;
      left: 20px;
      top: 150px;
      text-align: left;
      border-right: 1px dashed #ccc;
      padding-right: 20px;
    }

    #create-time {
      text-align: right;
      font-size: 0.8em;
      width: 70%;
    }

    .stat-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-icon {
      margin-right: 5px;
    }

    /* Êñ∞Â¢ûÊåâÈíÆÊ†∑Âºè */
    .like-button,
    .collect-button {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
    }

    .like-button.liked {
      color: red;
    }

    .collect-button.collected {
      color: gold;
    }

    /* ËØÑËÆ∫Ê°ÜÂíåËØÑËÆ∫ÊåâÈíÆÊ†∑Âºè */
    #comment-container {
      display: flex;
      align-items: center;
      width: 70%;
      margin-bottom: 20px;
    }

    #comment-box {
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 10px;
      flex: 1;
      margin-right: 10px;
      outline: none;
    }

    #comment-button {
      border: none;
      background-color: #007BFF;
      color: white;
      border-radius: 20px;
      padding: 10px 20px;
      cursor: pointer;
    }

    /* ËØÑËÆ∫Âå∫Ê†∑Âºè */
    #comment-section {
      width: 70%;
      text-align: left;
      font-size: 0.9em;
    }

    .comment-item {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .comment-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 10px;
    }

    .comment-info {
      display: flex;
      flex-direction: column;
    }

    .comment-author {
      font-weight: bold;
    }

    .comment-time {
      font-size: 0.8em;
      color: #888;
    }
  </style>
</head>

<body>
<h1 id="article-title"></h1>
<div id="author-info">
  <div id="author-avatar"></div>
  <span id="author-name"></span>
</div>
<div id="article-content"></div>
<div id="article-stats">
  <div class="stat-item">
    <!-- ‰øÆÊîπ‰∏∫ÊåâÈíÆ -->
    <button class="like-button" id="like-button">
      <span class="stat-icon">‚ù§Ô∏è</span>
      <span id="likes-num"></span>
    </button>
  </div>
  <div class="stat-item">
    <span class="stat-icon">üëÅÔ∏è</span>
    <span id="read-num"></span>
  </div>
  <div class="stat-item">
    <!-- ‰øÆÊîπ‰∏∫ÊåâÈíÆ -->
    <button class="collect-button" id="collect-button">
      <span class="stat-icon">‚≠ê</span>
      <span id="collect-num"></span>
    </button>
  </div>
</div>
<div id="create-time"></div>
<!-- Êñ∞Â¢ûËØÑËÆ∫Ê°ÜÂíåËØÑËÆ∫ÊåâÈíÆ -->
<div id="comment-container">
  <input type="text" id="comment-box" placeholder="ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ">
  <button id="comment-button">ËØÑËÆ∫</button>
</div>
<!-- Êñ∞Â¢ûËØÑËÆ∫Âå∫ -->
<div id="comment-section"></div>

<script>
  // ‰ªéURL‰∏≠Ëé∑ÂèñÂèÇÊï∞
  const urlParams = new URLSearchParams(window.location.search);
  const articleId = urlParams.get('articleId');
  const authorization = localStorage.getItem('authorization')

  if (!articleId ||!authorization) {
    alert('Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞ÔºåËØ∑ÈáçÊñ∞ËÆøÈóÆ„ÄÇ');
    window.location.href = 'index.html';
  } else {
    // ÂèëËµ∑ËØ∑Ê±ÇËé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖ
    function fetchArticleDetail() {
      fetch(`http://127.0.0.1/api/user/article/detail?articleId=${articleId}`, {
        method: 'GET',
        headers: {
          'Authorization': `${authorization}`,
          'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
        }
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(data => {
                if (data.code === '200') {
                  const articleData = data.data;
                  document.getElementById('article-title').textContent = articleData.title;
                  document.getElementById('author-name').textContent = articleData.userInfo.username;
                  document.getElementById('article-content').textContent = articleData.content;
                  document.getElementById('likes-num').textContent = articleData.likesNum;
                  document.getElementById('read-num').textContent = articleData.readNum;
                  document.getElementById('collect-num').textContent = articleData.collectNum;
                  document.getElementById('create-time').textContent = articleData.createTime;
                  // ÂàùÂßãÂä†ËΩΩÊó∂Êü•ËØ¢ÁÇπËµûÂíåÊî∂ËóèÁä∂ÊÄÅ
                  checkLikeStatus();
                  checkCollectStatus();
                  // Âä†ËΩΩËØÑËÆ∫ÂàóË°®
                  fetchCommentList();
                }
              })
              .catch(error => {
                const errorMessage = `ÂèëÁîüÈîôËØØ: ${error.message}`;
                alert(errorMessage);
              });
    }
    fetchArticleDetail();
  }

  // Êü•ËØ¢ÁÇπËµûÁä∂ÊÄÅ
  function checkLikeStatus() {
    fetch(`http://127.0.0.1/api/user/article/like?articleId=${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const likeButton = document.getElementById('like-button');
                if (data.data.like) {
                  likeButton.classList.add('liked');
                } else {
                  likeButton.classList.remove('liked');
                }
              }
            })
            .catch(error => {
              console.error('Êü•ËØ¢ÁÇπËµûÁä∂ÊÄÅÈîôËØØ:', error);
            });
  }

  // Êü•ËØ¢Êî∂ËóèÁä∂ÊÄÅ
  function checkCollectStatus() {
    fetch(`http://127.0.0.1/api/user/article/collect?articleId=${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const collectButton = document.getElementById('collect-button');
                if (data.data.collect) {
                  collectButton.classList.add('collected');
                } else {
                  collectButton.classList.remove('collected');
                }
              }
            })
            .catch(error => {
              console.error('Êü•ËØ¢Êî∂ËóèÁä∂ÊÄÅÈîôËØØ:', error);
            });
  }

  // ÁÇπËµû/ÂèñÊ∂àÁÇπËµû
  document.getElementById('like-button').addEventListener('click', function () {
    const likeButton = this;
    fetch(`http://127.0.0.1/api/user/article/like/${articleId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                // ÈáçÊñ∞Êü•ËØ¢ÁÇπËµûÁä∂ÊÄÅ
                checkLikeStatus();
                // ÈáçÊñ∞Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖ
                fetchArticleDetail();
              }
            })
            .catch(error => {
              console.error('ÁÇπËµû/ÂèñÊ∂àÁÇπËµûÈîôËØØ:', error);
            });
  });

  // Êî∂Ëóè/ÂèñÊ∂àÊî∂Ëóè
  document.getElementById('collect-button').addEventListener('click', function () {
    const collectButton = this;
    fetch(`http://127.0.0.1/api/user/article/collect/${articleId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                // ÈáçÊñ∞Êü•ËØ¢Êî∂ËóèÁä∂ÊÄÅ
                checkCollectStatus();
                // ÈáçÊñ∞Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖ
                fetchArticleDetail();
              }
            })
            .catch(error => {
              console.error('Êî∂Ëóè/ÂèñÊ∂àÊî∂ËóèÈîôËØØ:', error);
            });
  });

  // Â§ÑÁêÜËØÑËÆ∫ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
  document.getElementById('comment-button').addEventListener('click', function () {
    const commentBox = document.getElementById('comment-box');
    const comment = commentBox.value.trim();
    // Ê∑ªÂä†ËØÑËÆ∫ÈïøÂ∫¶ÈôêÂà∂Ê£ÄÊü•
    if (comment.length > 100) {
      alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩË∂ÖËøá100‰∏™Â≠óÁ¨¶');
      return;
    }
    if (comment!== '') {
      fetch('http://127.0.0.1/api/user/article/comment', {
        method: 'POST',
        headers: {
          'Authorization': `${authorization}`,
          'User-Agent': 'Apifox/1.0.0 (https://apifox.com)',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          articleId: parseInt(articleId),
          comment: comment,
          level: 1
        })
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === '200') {
                  alert('ËØÑËÆ∫ÊàêÂäü');
                  commentBox.value = ''; // Ê∏ÖÁ©∫ËØÑËÆ∫Ê°Ü
                  // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫ÂàóË°®
                  fetchCommentList();
                } else {
                  alert('ËØÑËÆ∫Â§±Ë¥•: ' + data.msg);
                }
              })
              .catch(error => {
                console.error('ËØÑËÆ∫ËØ∑Ê±ÇÈîôËØØ:', error);
                alert('ËØÑËÆ∫ËØ∑Ê±ÇÂèëÁîüÈîôËØØ');
              });
    } else {
      alert('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ');
    }
  });

  // Ëé∑ÂèñËØÑËÆ∫ÂàóË°®
  function fetchCommentList() {
    fetch(`http://127.0.0.1/api/user/article/comment/${articleId}`, {
      method: 'GET',
      headers: {
        'Authorization': `${authorization}`,
        'User-Agent': 'Apifox/1.0.0 (https://apifox.com)'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === '200') {
                const commentSection = document.getElementById('comment-section');
                commentSection.innerHTML = ''; // Ê∏ÖÁ©∫ËØÑËÆ∫Âå∫
                const comments = data.data;
                comments.forEach(comment => {
                  const commentItem = document.createElement('div');
                  commentItem.classList.add('comment-item');

                  const commentAvatar = document.createElement('div');
                  commentAvatar.classList.add('comment-avatar');

                  const commentInfo = document.createElement('div');
                  commentInfo.classList.add('comment-info');

                  const commentAuthor = document.createElement('span');
                  commentAuthor.classList.add('comment-author');
                  commentAuthor.textContent = `${comment.userCommentInfo.username}: `;

                  const commentContent = document.createElement('span');
                  commentContent.textContent = comment.articleCommentInfo.comment;

                  const commentTime = document.createElement('span');
                  commentTime.classList.add('comment-time');
                  commentTime.textContent = comment.articleCommentInfo.createTime;

                  commentInfo.appendChild(commentAuthor);
                  commentInfo.appendChild(commentContent);
                  commentInfo.appendChild(commentTime);

                  commentItem.appendChild(commentAvatar);
                  commentItem.appendChild(commentInfo);

                  commentSection.appendChild(commentItem);
                });
              }
            })
            .catch(error => {
              console.error('Ëé∑ÂèñËØÑËÆ∫ÂàóË°®ÈîôËØØ:', error);
            });
  }
</script>
</body>

</html>